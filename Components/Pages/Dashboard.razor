@page "/dashboard"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using VacationTracker.Data.Entities
@using VacationTracker.Services
@using VacationTracker.Components.Shared
@attribute [Authorize]
@inject IVacationService VacationService
@inject IUserService UserService
@inject AuthenticationStateProvider AuthStateProvider

<div class="app-section">
    <div class="app-toolbar">
        <div>
            <h2 class="page-title mb-1">Dashboard</h2>
            <p class="subtle-text mb-0">Manage your vacation requests and view team availability.</p>
        </div>
    </div>

    @if (_user != null)
    {
        <div class="row g-3 mb-4">
            <div class="col-md-6">
                <div class="stat-card h-100">
                    <div class="stat-card__label">WEEKS USED</div>
                    <div class="stat-card__value text-success">@_weeksUsed/@_user.WeekQuota Weeks</div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="stat-card h-100">
                    <div class="stat-card__label">SINGLE DAYS USED</div>
                    <div class="stat-card__value text-primary">@_singleDaysUsed/@_user.DayQuota Days</div>
                </div>
            </div>
        </div>
    }

    <div class="data-panel">
        <div class="data-panel__toolbar">
            <ViewToggle CurrentView="_currentView" OnViewChanged="HandleViewChanged" />
        </div>

        <div class="data-panel__body">
            @if (_currentView == ViewToggle.ViewMode.Week)
            {
                <WeekView OnWeekSelected="HandleWeekSelected" />
            }
            else if (_currentView == ViewToggle.ViewMode.Day)
            {
                <DayView OnDaySelected="HandleDaySelected" />
            }
        </div>
    </div>
</div>

@if (_showConfirmationModal)
{
    <ConfirmationModal 
        DateRange="@_confirmDateRange" 
        ErrorMessage="@_errorMessage"
        IsSubmitting="_isSubmitting"
        OnConfirm="ConfirmQuickBooking"
        OnCancel="() => _showConfirmationModal = false" />
}

@code {
    private User? _user;
    private List<VacationRequest> _allRequests = new();
    private int _weeksUsed = 0;
    private int _singleDaysUsed = 0;
    private bool _showConfirmationModal = false;
    private VacationRequest _newRequest = new() { StartDate = DateTime.Today, EndDate = DateTime.Today };
    private string _errorMessage = "";
    private string _confirmDateRange = "";
    private bool _isSubmitting = false;
    private ViewToggle.ViewMode _currentView = ViewToggle.ViewMode.Week;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var email = authState.User.FindFirst(System.Security.Claims.ClaimTypes.Email)?.Value;

        if (email != null)
        {
            _user = await UserService.GetUserByEmailAsync(email);
            if (_user != null)
            {
                _newRequest.UserId = _user.Id;
                await LoadData();
            }
        }
    }

    private async Task LoadData()
    {
        _allRequests = await VacationService.GetRequestsAsync();
        if (_user != null)
        {
            var userRequests = await VacationService.GetRequestsByUserAsync(_user.Id);
            
            var approvedVacations = userRequests
                .Where(r => r.Status == Status.Approved && r.Type == RequestType.Vacation)
                .ToList();

            _weeksUsed = approvedVacations.Count(r => r.IsWeekBooking);
            _singleDaysUsed = approvedVacations.Count(r => !r.IsWeekBooking);
        }
    }

    private void HandleViewChanged(ViewToggle.ViewMode mode)
    {
        _currentView = mode;
    }

    private void HandleWeekSelected((DateTime Start, DateTime End) range)
    {
        _errorMessage = "";
        _newRequest.StartDate = range.Start;
        _newRequest.EndDate = range.End;
        _newRequest.IsWeekBooking = true;
        _confirmDateRange = $"{range.Start:MMM d} - {range.End:MMM d}, {range.Start:yyyy}";
        _showConfirmationModal = true;
    }

    private void HandleDaySelected(DateTime date)
    {
        _errorMessage = "";
        _newRequest.StartDate = date;
        _newRequest.EndDate = date;
        _newRequest.IsWeekBooking = false;
        _confirmDateRange = $"{date:MMMM d, yyyy}";
        _showConfirmationModal = true;
    }

    private async Task ConfirmQuickBooking()
    {
        await SubmitRequest();
        if (string.IsNullOrEmpty(_errorMessage))
        {
            _showConfirmationModal = false;
            StateHasChanged(); // Refresh views
        }
    }

    private async Task SubmitRequest()
    {
        if (_newRequest.EndDate < _newRequest.StartDate)
        {
            _errorMessage = "End date cannot be earlier than start date.";
            return;
        }

        _isSubmitting = true;
        _errorMessage = "";

        try
        {
            var result = await VacationService.CreateRequestAsync(_newRequest);
            if (result.Success)
            {
                _newRequest = new() { StartDate = DateTime.Today, EndDate = DateTime.Today, UserId = _user!.Id };
                await LoadData();
            }
            else
            {
                _errorMessage = result.Message;
                // If it was a quick booking, we might want to show this error in the confirmation modal instead
                if (_showConfirmationModal)
                {
                    // For now just alert it
                    await Task.Yield();
                }
            }
        }
        catch (Exception)
        {
            _errorMessage = "An error occurred while submitting your request.";
        }
        finally
        {
            _isSubmitting = false;
        }
    }
}
