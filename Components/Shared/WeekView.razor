@using VacationTracker.Services
@using VacationTracker.Data.Entities
@inject IVacationService VacationService

<div class="week-view">
    <div class="month-nav d-flex align-items-center justify-content-between mb-4">
        <button class="btn btn-icon" @onclick="PrevMonth"><i class="bi bi-chevron-left"></i></button>
        <h4 class="mb-0">@_currentMonth.ToString("MMMM yyyy")</h4>
        <button class="btn btn-icon" @onclick="NextMonth"><i class="bi bi-chevron-right"></i></button>
    </div>

    <div class="calendar-weeks-scroll">
        <div class="calendar-weeks-grid">
            <div class="week-header">Week</div>
            <div class="week-header">Mon</div>
            <div class="week-header">Tue</div>
            <div class="week-header">Wed</div>
            <div class="week-header">Thu</div>
            <div class="week-header">Fri</div>
            <div class="week-header">Sat</div>
            <div class="week-header">Sun</div>

            @foreach (var week in _weeks)
            {
                var userWeekRequest = GetUserWeekRequest(week.Start, week.End);
                var hasUserOverlap = HasUserOverlap(week.Start, week.End);
                <div class="week-row @(week.IsFull ? "full" : "") @(hasUserOverlap ? "user-blocked" : "") @(userWeekRequest != null ? "user-week" : "")" @onclick="() => SelectWeek(week)">
                    <!-- Week Info Column -->
                    <div class="week-info-cell">
                        <div class="week-number">W@(week.WeekNumber)</div>
                        <div class="week-spots">
                            <span class="badge @(week.IsFull ? "bg-danger" : "bg-success")">
                                @week.Taken/@week.Total
                            </span>
                        </div>
                    </div>

                    <!-- Days Columns -->
                    @foreach (var day in week.Days)
                    {
                        var userDayRequest = GetUserDayRequestForDate(day);
                        <div class="day-cell @(day.Month != _currentMonth.Month ? "outside" : "") @(day.Date == DateTime.Today ? "today" : "") @(userDayRequest != null ? "user-day" : "")">
                            <div class="day-number">@day.Day</div>
                            @if (day.DayOfWeek == DayOfWeek.Monday && userWeekRequest != null)
                            {
                                <span class="user-week-tag @GetUserStatusClass(userWeekRequest.Status)">Your week</span>
                            }
                            @if (userDayRequest != null)
                            {
                                <span class="user-day-tag @GetUserStatusClass(userDayRequest.Status)">You</span>
                            }
                        </div>
                    }
                </div>
            }
        </div>
    </div>
</div>

@code {
    [Parameter] public EventCallback<(DateTime Start, DateTime End)> OnWeekSelected { get; set; }
    [Parameter] public List<VacationRequest> UserRequests { get; set; } = new();
    [Parameter] public int? EditingRequestId { get; set; }
    
    private DateTime _currentMonth = new DateTime(DateTime.Today.Year, DateTime.Today.Month, 1);
    private List<WeekInfo> _weeks = new();
    private List<VacationRequest> _activeRequests = new();
    private List<VacationRequest> _activeWeekRequests = new();
    private Dictionary<DateTime, VacationRequest> _dayRequestsByDate = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadWeeks();
    }

    protected override void OnParametersSet()
    {
        BuildRequestLookups();
    }

    private async Task LoadWeeks()
    {
        _weeks.Clear();
        var firstDayOfMonth = _currentMonth;
        
        // Find the first Monday
        var startDay = firstDayOfMonth.AddDays(-(int)firstDayOfMonth.DayOfWeek + (int)DayOfWeek.Monday);
        if (firstDayOfMonth.DayOfWeek == DayOfWeek.Sunday) startDay = firstDayOfMonth.AddDays(-6);

        for (int i = 0; i < 6; i++) // Always show 6 weeks for consistency
        {
            var weekStart = startDay.AddDays(i * 7);
            var weekEnd = weekStart.AddDays(6);
            var (taken, total) = await VacationService.GetWeekAvailabilityAsync(weekStart);
            
            var days = new List<DateTime>();
            for (int d = 0; d < 7; d++)
            {
                days.Add(weekStart.AddDays(d));
            }

            _weeks.Add(new WeekInfo
            {
                Start = weekStart,
                End = weekEnd,
                WeekNumber = GetIsoWeekNumber(weekStart),
                Taken = taken,
                Total = total,
                Days = days
            });
        }
    }

    private async Task PrevMonth()
    {
        _currentMonth = _currentMonth.AddMonths(-1);
        await LoadWeeks();
    }

    private async Task NextMonth()
    {
        _currentMonth = _currentMonth.AddMonths(1);
        await LoadWeeks();
    }

    private void SelectWeek(WeekInfo week)
    {
        if (!week.IsFull && !HasUserOverlap(week.Start, week.End))
        {
            OnWeekSelected.InvokeAsync((week.Start, week.End));
        }
    }

    private int GetIsoWeekNumber(DateTime date)
    {
        var day = (int)System.Globalization.CultureInfo.InvariantCulture.Calendar.GetDayOfWeek(date);
        return System.Globalization.CultureInfo.InvariantCulture.Calendar.GetWeekOfYear(date.AddDays(4 - (day == 0 ? 7 : day)), System.Globalization.CalendarWeekRule.FirstFourDayWeek, DayOfWeek.Monday);
    }

    private VacationRequest? GetUserWeekRequest(DateTime weekStart, DateTime weekEnd)
    {
        return _activeWeekRequests.FirstOrDefault(r =>
            r.StartDate.Date <= weekEnd.Date &&
            r.EndDate.Date >= weekStart.Date);
    }

    private VacationRequest? GetUserDayRequestForDate(DateTime date)
    {
        return _dayRequestsByDate.TryGetValue(date.Date, out var request) ? request : null;
    }

    private bool HasUserOverlap(DateTime start, DateTime end)
    {
        return _activeRequests.Any(r =>
            (!EditingRequestId.HasValue || r.Id != EditingRequestId.Value) &&
            r.StartDate.Date <= end.Date &&
            r.EndDate.Date >= start.Date);
    }

    private string GetUserStatusClass(Status status)
    {
        return status == Status.Pending ? "pending" : "approved";
    }

    private void BuildRequestLookups()
    {
        _activeRequests = UserRequests
            .Where(r => r.Type == RequestType.Vacation && r.Status != Status.Rejected)
            .ToList();

        _activeWeekRequests = _activeRequests
            .Where(r => r.IsWeekBooking)
            .ToList();

        _dayRequestsByDate = new Dictionary<DateTime, VacationRequest>();
        foreach (var request in _activeRequests.Where(r => !r.IsWeekBooking))
        {
            var current = request.StartDate.Date;
            var end = request.EndDate.Date;
            while (current <= end)
            {
                _dayRequestsByDate.TryAdd(current, request);
                current = current.AddDays(1);
            }
        }
    }

    private class WeekInfo
    {
        public DateTime Start { get; set; }
        public DateTime End { get; set; }
        public int WeekNumber { get; set; }
        public int Taken { get; set; }
        public int Total { get; set; }
        public List<DateTime> Days { get; set; } = new();
        public bool IsFull => Taken >= Total;
    }
}
