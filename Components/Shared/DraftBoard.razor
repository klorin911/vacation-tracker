@using VacationTracker.Services
@using VacationTracker.Data.Entities
@inject IDraftService DraftService
@inject IVacationService VacationService

<div class="draft-board">
    <div class="draft-week-header">
        <div class="draft-week-meta">Week</div>
        <div class="draft-week-days">
            <div class="day-label">Mon</div>
            <div class="day-label">Tue</div>
            <div class="day-label">Wed</div>
            <div class="day-label">Thu</div>
            <div class="day-label">Fri</div>
            <div class="day-label">Sat</div>
            <div class="day-label">Sun</div>
        </div>
        <div class="draft-week-actions">Action</div>
    </div>

    <div class="draft-week-stack">
        @foreach (var week in _weeks)
        {
            <div class="draft-week-row @(GetWeekStatusClass(week))">
                <div class="draft-week-meta">
                    <div class="week-number">W@(week.WeekNumber)</div>
                    <div class="week-range">@week.Start.ToString("MMM d") - @week.End.ToString("MMM d")</div>
                    <div class="week-availability">@week.Taken/@week.Total</div>
                </div>
                <div class="draft-week-days">
                    @foreach (var day in week.Days)
                    {
                        <div class="day-cell @(day.Date.Month == week.Start.Month ? "" : "outside")">
                            <div class="day-date">@day.Date.ToString("MMM d")</div>
                            <div class="day-dow">@day.DayOfWeek.ToString().Substring(0, 3)</div>
                        </div>
                    }
                </div>
                <div class="draft-week-actions">
                    @if (CanPick(week))
                    {
                        <button class="btn btn-sm btn-primary" @onclick="() => MakePick(week)">PICK</button>
                    }
                    else if (CanQueue(week))
                    {
                        <button class="btn btn-sm btn-outline-secondary" @onclick="() => AddToQueue(week)">+ QUEUE</button>
                    }
                    else if (IsMyPick(week))
                    {
                        <span class="badge bg-success">YOUR PICK</span>
                    }
                    else
                    {
                        <span class="text-muted small">â€”</span>
                    }
                </div>
            </div>
        }
    </div>
</div>

<style>
    .draft-week-header {
        display: grid;
        grid-template-columns: 160px 1fr 120px;
        align-items: center;
        gap: 1rem;
        padding: 0.5rem 1rem;
        background: var(--surface-3);
        border: 1px solid var(--border);
        border-radius: var(--radius-md);
        font-weight: 600;
        font-size: 0.85rem;
    }
    .draft-week-stack {
        margin-top: 0.75rem;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }
    .draft-week-row {
        display: grid;
        grid-template-columns: 160px 1fr 120px;
        align-items: center;
        gap: 1rem;
        padding: 0.6rem 1rem;
        background: var(--surface-2);
        border: 1px solid var(--border);
        border-radius: var(--radius-md);
    }
    .draft-week-row.full {
        opacity: 0.7;
        background: var(--surface-1);
    }
    .draft-week-row.my-pick {
        background: var(--success-soft);
        border-color: color-mix(in srgb, var(--success) 40%, var(--border));
    }
    .draft-week-meta {
        display: flex;
        flex-direction: column;
        gap: 0.1rem;
    }
    .week-number {
        font-weight: 700;
        color: var(--ink-900);
    }
    .week-range {
        font-size: 0.8rem;
        color: var(--ink-600);
    }
    .week-availability {
        font-size: 0.75rem;
        color: var(--ink-500);
    }
    .draft-week-days {
        display: grid;
        grid-template-columns: repeat(7, minmax(0, 1fr));
        gap: 0.35rem;
    }
    .day-label {
        font-size: 0.7rem;
        letter-spacing: 0.04em;
        text-transform: uppercase;
        color: var(--ink-500);
        text-align: center;
    }
    .day-cell {
        padding: 0.3rem 0.35rem;
        border-radius: var(--radius-sm);
        border: 1px solid var(--divider);
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.05rem;
        background: var(--surface-1);
    }
    .day-cell.outside {
        opacity: 0.6;
    }
    .day-date {
        font-size: 0.72rem;
        font-weight: 600;
        color: var(--ink-800);
    }
    .day-dow {
        font-size: 0.65rem;
        color: var(--ink-500);
        text-transform: uppercase;
    }
    .draft-week-actions {
        display: flex;
        justify-content: flex-end;
    }
    @@media (max-width: 992px) {
        .draft-week-header,
        .draft-week-row {
            grid-template-columns: 1fr;
        }
        .draft-week-actions {
            justify-content: flex-start;
        }
    }
</style>

@code {
    [Parameter] public int UserId { get; set; }
    [Parameter] public bool IsMyTurn { get; set; }
    [Parameter] public DraftSession? Session { get; set; }
    [Parameter] public EventCallback OnUpdate { get; set; }

    private List<WeekInfo> _weeks = new();
    private List<VacationRequest> _myPicks = new();
    private HashSet<DateTime> _myPickWeekStarts = new();

    protected override async Task OnParametersSetAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        _myPicks = await VacationService.GetRequestsByUserAsync(UserId);
        _myPickWeekStarts = _myPicks
            .Where(r => r.Type == RequestType.Vacation && r.IsWeekBooking)
            .Select(r => r.StartDate.Date)
            .ToHashSet();
        
        var year = DateTime.Today.Year;
        _weeks.Clear();

        var current = new DateTime(year, 1, 1);
        while (current.DayOfWeek != DayOfWeek.Monday) current = current.AddDays(1);

        for (int i = 0; i < 52; i++)
        {
            var weekStart = current.AddDays(i * 7);
            var weekEnd = weekStart.AddDays(6);
            var (taken, total) = await VacationService.GetWeekAvailabilityAsync(weekStart);

            var days = new List<DateTime>(7);
            for (int d = 0; d < 7; d++)
            {
                days.Add(weekStart.AddDays(d));
            }

            _weeks.Add(new WeekInfo
            {
                Start = weekStart,
                End = weekEnd,
                Taken = taken,
                Total = total,
                Days = days,
                WeekNumber = GetIsoWeekNumber(weekStart)
            });
        }
    }

    private bool CanPick(WeekInfo week)
    {
        return IsMyTurn && week.Taken < week.Total && !IsMyPick(week) && Session is { IsActive: true, IsPaused: false };
    }

    private bool CanQueue(WeekInfo week)
    {
        return !IsMyTurn && week.Taken < week.Total && !IsMyPick(week);
    }

    private bool IsMyPick(WeekInfo week)
    {
        return _myPickWeekStarts.Contains(week.Start.Date);
    }

    private string GetWeekStatusClass(WeekInfo week)
    {
        if (IsMyPick(week)) return "my-pick";
        if (week.Taken >= week.Total) return "full";
        return "";
    }

    private async Task MakePick(WeekInfo week)
    {
        var result = await DraftService.MakePickAsync(UserId, week.Start);
        if (result.Success)
        {
            await OnUpdate.InvokeAsync();
        }
    }

    private async Task AddToQueue(WeekInfo week)
    {
        await DraftService.AddToQueueAsync(UserId, week.Start);
        await OnUpdate.InvokeAsync();
    }

    private class WeekInfo
    {
        public DateTime Start { get; set; }
        public DateTime End { get; set; }
        public int Taken { get; set; }
        public int Total { get; set; }
        public List<DateTime> Days { get; set; } = new();
        public int WeekNumber { get; set; }
    }

    private int GetIsoWeekNumber(DateTime date)
    {
        var day = (int)System.Globalization.CultureInfo.InvariantCulture.Calendar.GetDayOfWeek(date);
        return System.Globalization.CultureInfo.InvariantCulture.Calendar.GetWeekOfYear(date.AddDays(4 - (day == 0 ? 7 : day)), System.Globalization.CalendarWeekRule.FirstFourDayWeek, DayOfWeek.Monday);
    }
}
