@using System.Security.Claims
@using VacationTracker.Components.Shared
@using VacationTracker.Data.Entities
@inject IJSRuntime JS

<div class="app-nav">
    <div class="app-nav__inner">
        <a class="app-brand" href="">VacationTracker</a>

        <input type="checkbox" id="nav-toggle" class="app-nav__toggle" />
        <label for="nav-toggle" class="app-nav__toggle-btn" aria-label="Toggle navigation">
            <span></span>
            <span></span>
            <span></span>
        </label>

        <nav class="app-nav__links">
            <AuthorizeView>
                <Authorized Context="navContext">
                    <NavLink class="app-nav__link" href="dashboard">Dashboard</NavLink>
                    <AuthorizeView Roles="@nameof(Role.Admin)">
                        <NavLink class="app-nav__link" href="admin">Admin</NavLink>
                    </AuthorizeView>
                    <div class="app-nav__mobile-only">
                        <div class="app-nav__divider"></div>
                        <div class="app-nav__mobile-theme-row">
                            <ThemeToggle />
                        </div>
                        <div class="app-nav__divider"></div>
                        <div class="app-nav__mobile-footer">
                            <span class="app-nav__mobile-user-info">@GetDisplayName(navContext.User)</span>
                            <a class="app-nav__mobile-logout" href="logout">
                                <i class="bi bi-box-arrow-right me-1"></i> Logout
                            </a>
                        </div>
                    </div>
                </Authorized>
                <NotAuthorized>
                    <NavLink class="app-nav__link app-nav__link--cta" href="login">Login</NavLink>
                </NotAuthorized>
            </AuthorizeView>
        </nav>

        <div class="app-nav__actions">
            <ThemeToggle />
            <AuthorizeView Context="authContext">
                <Authorized>
                    @{
                        var displayName = GetDisplayName(authContext.User);
                        var initial = GetInitial(displayName);
                    }
                    <details class="app-nav__dropdown">
                        <summary class="app-nav__user">
                            <span class="app-nav__avatar">@initial</span>
                            <span class="app-nav__user-name">@displayName</span>
                        </summary>
                        <div class="app-nav__menu">
                            <a class="app-nav__menu-item" href="logout">Logout</a>
                        </div>
                    </details>
                </Authorized>
            </AuthorizeView>
        </div>
    </div>
</div>

@code {
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JS.InvokeVoidAsync("vacationTracker.initNavDropdowns");
        }
    }

    private static string GetDisplayName(ClaimsPrincipal user)
    {
        return user.Identity?.Name
            ?? user.FindFirst(ClaimTypes.Email)?.Value
            ?? "Account";
    }

    private static string GetInitial(string displayName)
    {
        return displayName.Length > 0 ? displayName.Substring(0, 1).ToUpperInvariant() : "U";
    }
}
