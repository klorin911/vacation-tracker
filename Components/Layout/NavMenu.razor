@using System.Security.Claims
@using Microsoft.AspNetCore.Components.Authorization
@using VacationTracker.Components.Shared
@using VacationTracker.Data.Entities
@using VacationTracker.Auth
@using VacationTracker.Services
@inject IUserService UserService
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager NavigationManager
@inject IWebHostEnvironment Environment
@inject IJSRuntime JS
@implements IDisposable

<div class="app-nav">
    <div class="app-nav__inner">
        <a class="app-brand" href="">VacationTracker</a>

        <input type="checkbox" id="nav-toggle" class="app-nav__toggle" />
        <label for="nav-toggle" class="app-nav__toggle-btn" aria-label="Toggle navigation">
            <span></span>
            <span></span>
            <span></span>
        </label>

        <nav class="app-nav__links">
            <AuthorizeView>
                <Authorized Context="navContext">
                    <NavLink class="app-nav__link" href="dashboard">Dashboard</NavLink>
                    <NavLink class="app-nav__link" href="draft">Draft</NavLink>
                    <AuthorizeView Roles="@nameof(Role.Supervisor)">
                        <NavLink class="app-nav__link" href="supervisor">Supervisor</NavLink>
                        <NavLink class="app-nav__link" href="supervisor/draft">Supervisor Draft</NavLink>
                    </AuthorizeView>
                    <div class="app-nav__mobile-only">
                        <div class="app-nav__divider"></div>
                        <div class="app-nav__mobile-theme-row">
                            <ThemeToggle />
                        </div>
                        <div class="app-nav__divider"></div>
                        <div class="app-nav__mobile-footer">
                            <span class="app-nav__mobile-user-info">@GetDisplayName(navContext.User)</span>
                            <a class="app-nav__mobile-logout" href="logout">
                                <i class="bi bi-box-arrow-right me-1"></i> Logout
                            </a>
                        </div>
                    </div>
                </Authorized>
                <NotAuthorized>
                    <NavLink class="app-nav__link app-nav__link--cta" href="login">Login</NavLink>
                </NotAuthorized>
            </AuthorizeView>
        </nav>

        <div class="app-nav__actions">
            <ThemeToggle />
            <AuthorizeView Context="authContext">
                <Authorized>
                    @{
                        var displayName = GetDisplayName(authContext.User);
                        var initial = GetInitial(displayName);
                    }
                    <details class="app-nav__dropdown">
                        <summary class="app-nav__user">
                            <span class="app-nav__avatar">@initial</span>
                            <span class="app-nav__user-name">@displayName</span>
                        </summary>
                        <div class="app-nav__menu">
                            @if (_showQuickSwitch)
                            {
                                <div class="app-nav__menu-section">
                                    <div class="app-nav__menu-label">Quick switch (dev)</div>
                                    @if (_switchSupervisors.Any())
                                    {
                                        <div class="app-nav__menu-group">Supervisors</div>
                                        @foreach (var supervisor in _switchSupervisors)
                                        {
                                            <button type="button"
                                                    class="app-nav__menu-item app-nav__menu-item--button"
                                                    disabled="@_isSwitching"
                                                    @onclick="() => SwitchUser(supervisor.Email)">
                                                @supervisor.Name
                                            </button>
                                        }
                                    }
                                    @if (_switchDispatchers.Any())
                                    {
                                        <div class="app-nav__menu-group">Dispatchers</div>
                                        @foreach (var dispatcher in _switchDispatchers)
                                        {
                                            <button type="button"
                                                    class="app-nav__menu-item app-nav__menu-item--button"
                                                    disabled="@_isSwitching"
                                                    @onclick="() => SwitchUser(dispatcher.Email)">
                                                @dispatcher.Name
                                            </button>
                                        }
                                    }
                                    @if (!string.IsNullOrWhiteSpace(_switchError))
                                    {
                                        <div class="app-nav__menu-error">@_switchError</div>
                                    }
                                </div>
                                <div class="app-nav__divider"></div>
                            }
                            <a class="app-nav__menu-item" href="logout">Logout</a>
                        </div>
                    </details>
                </Authorized>
            </AuthorizeView>
        </div>
    </div>
</div>

@code {
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JS.InvokeVoidAsync("vacationTracker.initNavDropdowns");
        }
    }

    protected override async Task OnInitializedAsync()
    {
        if (!Environment.IsDevelopment())
        {
            return;
        }

        AuthStateProvider.AuthenticationStateChanged += OnAuthenticationStateChanged;

        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        await TryLoadQuickSwitchAsync(authState.User);
    }

    public void Dispose()
    {
        AuthStateProvider.AuthenticationStateChanged -= OnAuthenticationStateChanged;
    }

    private static string GetDisplayName(ClaimsPrincipal user)
    {
        return user.Identity?.Name
            ?? user.FindFirst(ClaimTypes.Email)?.Value
            ?? "Account";
    }

    private static string GetInitial(string displayName)
    {
        return displayName.Length > 0 ? displayName.Substring(0, 1).ToUpperInvariant() : "U";
    }

    private async Task SwitchUser(string email)
    {
        _switchError = "";
        _isSwitching = true;

        try
        {
            if (AuthStateProvider is not CustomAuthStateProvider customAuthStateProvider)
            {
                _switchError = "Auth provider is not configured correctly.";
                return;
            }

            var user = await UserService.GetUserByEmailAsync(email);
            if (user == null)
            {
                _switchError = "User not found.";
                return;
            }

            await customAuthStateProvider.UpdateAuthenticationState(email);
            await JS.InvokeVoidAsync("vacationTracker.setCookie", "vt_user", email, 7);
            NavigationManager.NavigateTo("/dashboard", forceLoad: true);
        }
        catch (Exception ex)
        {
            _switchError = $"Switch failed: {ex.Message}";
        }
        finally
        {
            _isSwitching = false;
        }
    }

    private async void OnAuthenticationStateChanged(Task<AuthenticationState> authStateTask)
    {
        var authState = await authStateTask;
        await InvokeAsync(async () =>
        {
            await TryLoadQuickSwitchAsync(authState.User);
            StateHasChanged();
        });
    }

    private async Task TryLoadQuickSwitchAsync(ClaimsPrincipal user)
    {
        if (_quickSwitchLoaded || _isLoadingQuickSwitch)
        {
            return;
        }

        if (user.Identity?.IsAuthenticated != true)
        {
            return;
        }

        _isLoadingQuickSwitch = true;

        try
        {
            var users = await UserService.GetUsersAsync();
            _switchSupervisors = users.Where(u => u.Role == Role.Supervisor).ToList();
            _switchDispatchers = users.Where(u => u.Role == Role.Dispatcher).ToList();
            _showQuickSwitch = _switchSupervisors.Count > 0 || _switchDispatchers.Count > 0;
            _quickSwitchLoaded = true;
        }
        finally
        {
            _isLoadingQuickSwitch = false;
        }
    }

    private List<User> _switchSupervisors = new();
    private List<User> _switchDispatchers = new();
    private string _switchError = "";
    private bool _isSwitching;
    private bool _showQuickSwitch;
    private bool _quickSwitchLoaded;
    private bool _isLoadingQuickSwitch;
}
